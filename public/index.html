<!DOCTYPE html>
<html lang="en">
<head>
    <!-- ibuenda cookie consent form -->
    <script type="text/javascript">
        var _iub = _iub || [];
        _iub.csConfiguration = {"siteId":3990689,"cookiePolicyId":80577973,"lang":"en-GB","storage":{"useSiteId":true}};
        </script>
        <script type="text/javascript" src="https://cs.iubenda.com/autoblocking/3990689.js"></script>
        <script type="text/javascript" src="//cdn.iubenda.com/cs/gpp/stub.js"></script>
        <script type="text/javascript" src="//cdn.iubenda.com/cs/iubenda_cs.js" charset="UTF-8" async></script>

    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-VPM1WZND56"></script>
    <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', 'G-VPM1WZND56');
    </script>
    <link rel="icon" href="/static/favicon.ico" sizes="any">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Droplet Login</title>
    <style>
        *, *::before, *::after {
            box-sizing: border-box;
        }
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f2f5; /* Very light gray */
            color: #222;
        }

        .login-container {
            width: 300px;
            padding: 2rem;
            background-color: white;
            border-radius: 0.5rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }

        h1 {
            text-align: center;
            color: #203171;
            margin-bottom: 1.5rem;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
            color: #333;
        }

        input {
            width: 100%;
            padding: 0.75rem;
            margin-bottom: 1rem;
            border: 1px solid #ccc;
            border-radius: 0.25rem;
        }

        button {
            width: 100%;
            padding: 0.75rem 1rem;
            background-color: #203171;
            color: white;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button:hover {
            background-color: #2a3e8f; /* Slightly lighter blue on hover */
        }

        .error-message {
            color: #d32f2f;
            margin-top: 1rem;
            text-align: center;
        }

        img {
            display: block;
            margin: 0 auto 1rem;
            height: 150px;
        }

        footer {
            background-color: #203171;
            color: white;
            text-align: center;
            padding: 10px;
            position: fixed;
            bottom: 0;
            width: 100%;
        }
        #demo-login-buttons {
            display: none; /* Initially hidden by inline style, shown by JS */
            margin-top: 1.5rem;
            border-top: 1px solid var(--color-border); /* Use variable */
            padding-top: 1.5rem;
            text-align: center; /* Center the paragraph above */
        }
        #demo-login-buttons p {
            text-align: center;
            color: var(--color-text-meta); /* Use variable */
            font-size: 0.9em;
            margin-bottom: 0.8rem;
            margin-top: 0;
        }

        /* Demo Login Button Style */
        .demo-button {
            display: block; /* Make buttons take full width of container */
            width: 100%;    /* Take full width */
            padding: 0.6rem 1rem; /* Slightly less padding than main button */
            margin-bottom: 0.5rem; /* Space between stacked buttons */
            font-size: 0.95rem; /* Slightly smaller font */
            font-family: inherit; /* Ensure font matches */
            border-radius: var(--border-radius); /* Use variable */
            cursor: pointer;
            transition: background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
            text-align: center;

            /* Option A: Secondary Button Style (e.g., Gray) */
            background-color: var(--color-bg-accent); /* Use light gray accent */
            border: 1px solid var(--color-border);
            color: var(--color-text-secondary);

            /* Option B: Outline Button Style
            background-color: transparent;
            border: 1px solid var(--color-primary);
            color: var(--color-primary);
            */
        }
        .demo-button:last-of-type {
            margin-bottom: 0;
        }

        /* Hover/Focus state for Demo Button */
        .demo-button:hover,
        .demo-button:focus {
            /* Option A Hover */
            background-color: #ddd; /* Slightly darker gray */
            border-color: #bbb;
            color: var(--color-text-primary);

            /* Option B Hover
            background-color: var(--color-primary-hover);
            color: var(--color-text-on-primary);
            border-color: var(--color-primary-hover);
            */
        }

        .demo-button:disabled { /* Style when clicked */
            background-color: #ccc;
            color: #888;
            cursor: not-allowed;
            border-color: #ccc;
        }
        .iub__us-widget {
            position: fixed !important; /* Force position out of flex flow */
            bottom: 10px !important;    /* Adjust distance from bottom */
            right: 10px !important;     /* Adjust distance from right */
            left: auto !important;      /* Prevent conflict with left positioning */
            top: auto !important;       /* Prevent conflict with top positioning */
            z-index: 10000 !important;  /* Ensure it's above other content (adjust if needed) */
            /* Reset any potentially problematic styles from Iubenda if needed */
            margin: 0 !important;
            transform: none !important; /* Reset transforms if they interfere */
            /* The widget itself might have internal sizing */
        }
    </style>
</head>
<body>
    <div class="login-container"> <img src="/static/images/droplet.png" alt="Droplet Logo">
        <h1>Droplet Login</h1>

        <form id="login-form">
            <label for="email">Email:</label>
            <input type="email" id="email" name="email" required>

            <label for="password">Password:</label>
            <input type="password" id="password" name="password" required>

            <button type="submit">Login</button>
        </form>

        <div id="demo-login-buttons" style="display: none; margin-top: 1.5rem; border-top: 1px solid var(--color-border); padding-top: 1.5rem;"> <p style="text-align: center; color: var(--color-text-meta); font-size: 0.9em; margin-bottom: 0.8rem;">Or login as:</p> <button type="button" class="demo-button" data-role="admin">Demo Admin</button>
            <button type="button" class="demo-button" data-role="user" style="margin-top: 0.5rem;">Demo User</button>
            </div>

        <div class="error-message" id="error-message">
            </div>

        </div>
    <footer>
        <p>&copy; 2025 Droplet. All rights reserved.</p>
    </footer>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
    
            // --- Elements ---
            const loginForm = document.getElementById('login-form');
            const errorMessage = document.getElementById('error-message');
            const demoButtonDiv = document.getElementById('demo-login-buttons');
    
            // --- Demo Credentials ---
            // IMPORTANT: Use dedicated accounts with limited permissions for demos.
            // Do NOT use real admin or user credentials here.
            const demoCredentials = {
                admin: { email: 'gregory.allen@dropletschool.co.uk', password: 'password123' }, // EXAMPLE ONLY
                user: { email: 'nicole.moore@dropletschool.co.uk', password: 'password123' } // EXAMPLE ONLY
                // Add other roles if you have more demo buttons
            };
    
            // --- Clear Stale Session Data ---
            sessionStorage.removeItem('accessToken');
            sessionStorage.removeItem('userInfo');
    
            // --- Reusable Login Function ---
            // Handles making the API call and processing the response
            async function performLogin(email, password) {
                errorMessage.textContent = ''; // Clear errors
                try {
                    const response = await fetch('/api/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ email, password }),
                    });
    
                    let data;
                    try {
                        const contentType = response.headers.get("content-type");
                        if (contentType && contentType.indexOf("application/json") !== -1) {
                            data = await response.json();
                        } else {
                             console.log("Non-JSON login response:", await response.text());
                        }
                    } catch (jsonError) {
                         console.error("Failed to parse JSON login response:", jsonError);
                         errorMessage.textContent = `An unexpected server response occurred (Status: ${response.status}).`;
                         return false; // Indicate failure
                    }
    
                    if (response.ok && data?.token) {
                        // Login Successful
                        sessionStorage.setItem('accessToken', data.token);
                        console.log("Access Token stored in sessionStorage.");
                        if (data.id && data.email && data.role) {
                            const userInfo = { id: data.id, email: data.email, role: data.role };
                            sessionStorage.setItem('userInfo', JSON.stringify(userInfo));
                            console.log("User Info stored in sessionStorage.");
                        }
                        console.log('Login successful, redirecting to /drops...');
                        window.location.href = '/drops'; // Redirect on success
                        return true; // Indicate success
                    } else {
                        // Login Failed
                        errorMessage.textContent = data?.error || `Login failed (Status: ${response.status})`;
                        console.error("Login failed:", response.status, data);
                        return false; // Indicate failure
                    }
                } catch (error) {
                    // Network Error or other exception
                    errorMessage.textContent = 'An error occurred during login: ' + error.message;
                    console.error("Login fetch error:", error);
                    return false; // Indicate failure
                }
            } // --- End performLogin ---
    
    
            // --- Main Login Form Submission ---
            if (loginForm) {
                loginForm.addEventListener('submit', async (event) => {
                    event.preventDefault();
                    const submitButton = loginForm.querySelector('button[type="submit"]');
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
    
                    if (!email || !password) {
                        errorMessage.textContent = 'Please enter both email and password.';
                        return;
                    }
    
                    if(submitButton) submitButton.disabled = true; // Disable button
                    await performLogin(email, password); // Call reusable login function
                    // Re-enable button regardless of success/failure (if login failed, user might want to try again)
                    if(submitButton) submitButton.disabled = false;
                });
            } else {
                 console.warn("Login form not found.");
            }
    
    
            // --- Demo Login Button Logic ---
            // Function to check status and show buttons
            async function checkAndShowDemoLogins() {
                if (!demoButtonDiv) return; // Exit if div doesn't exist
                try {
                    const response = await fetch('/api/status');
                    if (!response.ok) { console.warn("Could not fetch API status."); return; }
                    const data = await response.json();
    
                    if (data && data.isDemoMode === true) {
                        console.log("Demo mode detected, showing demo login buttons.");
                        demoButtonDiv.style.display = 'block'; // Make the div visible
    
                        // Attach listeners AFTER buttons are visible (or just query here)
                        document.querySelectorAll('.demo-button').forEach(button => {
                            button.addEventListener('click', async () => {
                                const role = button.dataset.role;
                                const creds = demoCredentials[role];
    
                                if (!creds) {
                                    errorMessage.textContent = 'Demo credentials not set for that role.';
                                    return;
                                }
                                // Disable button clicked
                                button.disabled = true;
                                button.textContent = 'Logging in...'; // Provide feedback
                                console.log(`Attempting demo login as ${role}...`);
    
                                await performLogin(creds.email, creds.password); // Call reusable login function
    
                                // Re-enable button if login failed (stayed on page)
                                button.disabled = false;
                                button.textContent = `Demo ${role.charAt(0).toUpperCase() + role.slice(1)}`; // Reset text
                            });
                        });
    
                    } else {
                         console.log("Demo mode not active.");
                         demoButtonDiv.style.display = 'none';
                    }
                } catch (error) {
                    console.error("Error checking demo status:", error);
                     demoButtonDiv.style.display = 'none';
                }
            }
    
            // --- Initial Actions ---
            checkAndShowDemoLogins(); // Check demo status when DOM is ready
    
        }); // --- End of DOMContentLoaded listener ---
    </script>
</body>
</html>